<script type="text/javascript">
	function sendCommand(id, cmd, input){
                var kw = document.getElementsByName('kw');
                for (var i = 0; i < kw.length; i++) {
                    if (kw[i].type === 'radio' && kw[i].checked) {
                        reskw = kw[i].value;
                    }
                }
                var cmdforsend = cmd.replace("0", reskw);
		var url="?sendCommand=1&id="+id+"&cmd="+cmdforsend;
		if (input == 1)
		{
			var text = prompt("Input parameter "+cmd+":", '');
			if (text == null) return;
			url=url+"&param="+text;
		}

		$.ajax({
			url: url,
			cache: false,
			/*success: function(html){
				alert(html);
			} */
		});
	}
</script>


<ul id="tab" class="nav nav-tabs">
		[#begin NAV-TABS#]
			<li><a data-toggle="tab" href="#[#DIV_ID#]"[#if NAV-N==0#] class="active"[#endif#]>[#TITLE#]</a></li>
		[#end NAV-TABS#]
</ul>
<br>

<div class="tab-content">

		[#begin NAV-TABS#]
			<li><a data-toggle="tab" href="#[#DIV_ID#]" class="active">[#TITLE#]</a></li>
			<div id="[#DIV_ID#]" class="tab-pane fade in">
				[#if TITLE=='Запись ключевого слова'#]

					<p>Здесь можно записать до шести ключевых слов по 3 образца каждого ключевого слова. Для избегания ложных срабатываний лучше записать словосочетание из двух слов и более. Для лучшего качества срабатывания лучше записывать с тем микрофоном, который будет использоваться для распознавания. Говорить надо в микрофон на терминале.</p>
					<input name="kw" type="radio" value="1" checked> 1е слово
					<input name="kw" type="radio" value="2"> 2е слово
					<input name="kw" type="radio" value="3"> 3е слово
					<input name="kw" type="radio" value="4"> 4е слово
					<input name="kw" type="radio" value="5"> 5е слово
					<input name="kw" type="radio" value="6"> 6е слово
					<hr/>
					<p>Запись первого образца ключевого слова</p>
					<button onclick="sendCommand([#ID#],'rec_0_1',0);return false;" title="Старт записи 1го образца ключевого слова" class="btn btn-default">Запись</button>
					<button onclick="sendCommand([#ID#],'play_0_1',0);return false;" title="Воспроизведение записи 1го образца ключевого слова" class="btn btn-default">Воспроизведение</button>
					<hr/>
					<p>Запись второго образца ключевого слова</p>
					<button onclick="sendCommand([#ID#],'rec_0_2',0);return false;" title="Старт записи 2го образца ключевого слова" class="btn btn-default">Запись</button>
					<button onclick="sendCommand([#ID#],'play_0_2',0);return false;" title="Воспроизведение записи 2го образца ключевого слова" class="btn btn-default">Воспроизведение</button>
					<hr/>
					<p>Запись третьего образца ключевого слова</p>
					<button onclick="sendCommand([#ID#],'rec_0_3',0);return false;" title="Старт записи 3го образца ключевого слова" class="btn btn-default">Запись</button>
					<button onclick="sendCommand([#ID#],'play_0_3',0);return false;" title="Воспроизведение записи 3го образца ключевого слова" class="btn btn-default">Воспроизведение</button>
					<hr/>
					<p>Последний этап тренировки ключевого слова надо сгенерить служебный файл из записанных образцов по которому и будет работать распознавание ключевого слова.</p>
					<button onclick="sendCommand([#ID#],'compile_0_1',0);return false;" title="Генерация служебного файла" class="btn btn-default">Компиляция</button>
					<hr/>
					<p>Удалить модель</p>
					<button onclick="sendCommand([#ID#],'del_0_1',0);return false;" title="Удалить модель" class="btn btn-default">Удалить</button>
					<!-- <hr/>
					<p>Применить настройки на терминале</p>
							<button onclick="sendCommand([#ID#],'save_0_1',0);return false;" title="Применить настройки" class="btn btn-default">Применить</button>
							-->
				[#else TITLE#]

					<form action="?" method="post" enctype="multipart/form-data" name="frmEdit" class="form-horizontal">
	        [#if OK#]
		        <div class="alert alert-success"><#LANG_DATA_SAVED#></div>
	        [#endif OK#]
	        [#if ERR#]
		        <div class="alert alert-danger"><#LANG_FILLOUT_REQURED#></div>
	        [#endif ERR#]
	        <fieldset>
	        [#if ID=""#]
		        <legend><#LANG_NEW_RECORD#></legend>
	        [#endif ID#]

					[#begin CASES#]
						<h2>[#CASE-NAME#]</h2>
						[#begin SETTINGS#]

						[#if SETTING-NAME = 'ID_TERMINAL'#]
							<input type="hidden" name="panel_whith_id_terminal" value="1">
			        [#if !IS_SET_ID_TERMINAL#]
				        <div class="form-group ">
				            <label for="id_terminal" class="col-lg-4 control-label" [#if ERR_NAME#] style="color:red;font-weight:bold"[#endif#]>
				            Терминал: *
				            </label>
				            <div class="col-lg-5">
				                <select name="id_terminal" class="form-control [#if ERR_ID_TERMINAL#]alert-danger[#endif#]" >
				                    <option value="">select
				                    [#begin ID_TERMINAL_OPTIONS#]<option value="[#ID#]"[#if SELECTED#] selected[#endif#]>[#TITLE#] | [#NAME#] | [#HOST#] | [#ONLINE#]
				                    [#end ID_TERMINAL_OPTIONS#]
				                </select>

				            </div>
				        </div>
			        [#endif IS_SET_ID_TERMINAL#]
						[#endif IS_SET_ID_TERMINAL#]


				        <div class="form-group">
									<label for="[#SETTING-NAME#]" class="col-lg-3 control-label"[#ERROR#]>
										[#SETTING-TITLE#] <img src="/img/helpicon.png" title="[#SETTING-DESC#]"/>
									</label>
				          <div class="col-lg-4">
											[#if SETTING-TYPE=="text"#]
												<input type="text" class="form-control" name="[#SETTING-NAME#]" value="[#SETTING-VALUE#]" id="[#SETTING-NAME#]">
											[#endif#]
											[#if SETTING-TYPE=="checkbox"#]
												<input type="checkbox" name="[#SETTING-NAME#]" value="1"[#if SETTING-VALUE="1"#] checked[#endif#]>
											[#endif#]
											[#if SETTING-TYPE=="select"#]
												<select name="SETTING-NAME" class="form-control" id="[#SETTING-NAME#]">
													[#begin SETTING-SELECT-OPTIONS#]
								            <option value="[#SETTING-SELECT-OPTIONS-VALUE#]"[#if SETTING-SELECT-OPTIONS-VALUE==SETTING-VALUE#] selected[#endif#]>[#SETTING-SELECT-OPTION-TITLE#]</option>
													[#end SETTING-SELECT-OPTIONS#]
								        </select>
											[#endif#]
				          </div>
				        </div>
							[#end SETTINGS#]
							<hr/>
					[#end CASES#]
					<input type="hidden" name="view_mode" value="<#VIEW_MODE#>">
	        <input type="hidden" name="edit_mode" value="<#EDIT_MODE#>">
	        <input type="hidden" name="panel_voice" value="1">
	        <input type="hidden" name="id_terminal" value="[#ID_TERMINAL#]">
	        <input type="hidden" name="mode" value="update">
	        [#if ID!=""#]
	            <input type="hidden" name="id" value="[#ID#]">
	        [#endif ID#]
	        </fieldset>
	        <div class="form-group">
	           <div class="col-lg-offset-3 col-lg-4">
							 <button type="submit" name="subm" value="Submit" class="btn btn-primary"><#LANG_SUBMIT#></button>
	                [#if ID!=""#]
	                [#else ID#]
	                    <button type="submit" name="subm" value="Add" class="btn btn-primary"><#LANG_ADD#></button>
	                [#endif ID#]
	                <a href="?" class="btn btn-default "><#LANG_CANCEL#></a>
	            </div>
	       </div>
	      </form>

		[#endif TITLE#]
		[#if TITLE=='Обслуживание'#]

			<p>Обновить терминал</p>
			<button onclick="sendCommand([#ID#],'update_0_0',0);return false;" title="Обновить" class="btn btn-default">Обновить</button>
			<hr/>

			<p>Откатить термина до предыдущего успешного обновления</p>
			<button onclick="sendCommand([#ID#],'rollback_0_0',0);return false;" title="Откатить" class="btn btn-default">Откатить</button>
			<hr/>
			<!-- remote_log -->
			<style>
					.log_outputtext {
					background-color: black;
					color: aliceblue;
					overflow-y: auto;
					overflow-x: hidden;
					max-width: 1000px;
					height: 500px;
					font-family: monospace;
					font-size: 12px;
					border-color: black;
					padding: 2px;
					border-width: thick;
					border-style: solid;
					}
			</style>
			<form name="remote_log_form">
					<p>
							Лог терминала
							<input type="button" name=clearButton value="Clear" onClick="clearText();">
							<input type="button" name=connectButton value="Connect" onClick="doConnectDisconnect();">
					</p>
					<input type="hidden" name="ws_token" value="token_is_unset">
					<input type="hidden" name="terminal_ip" value="[#IP_TERMINAL#]">
			</form>
			<div id="log_outputtext" class="log_outputtext"></div>

			<script language="javascript" type="text/javascript">
					var remote_log = document.getElementById("log_outputtext");
					// ansi color -> html; https://github.com/mmalecki/ansispan
					var ansispan = function (str) {
						Object.keys(ansispan.foregroundColors).forEach(function (ansi) {
							var span = '<span style="color: ' + ansispan.foregroundColors[ansi] + '">';
							str = str.replace(
								new RegExp('\033\\[' + ansi + 'm', 'g'),
								span
							).replace(
								new RegExp('\033\\[1;' + ansi + 'm', 'g'),
								span
							);
						});
						return restoreURI(str.replace(/\033\[0m/g, '</span>'));
					};

					ansispan.foregroundColors = {
						'36': 'cyan',
						'90': 'gray',
						'92': 'mediumspringgreen',
						'93': 'yellow',
						'91': 'red',
						'95': 'darkred'
					};

					// replace start
					var tagsToReplace = {
							'&': '&amp;',
							'<': '&lt;',
							'>': '&gt;'
					};

					function replaceTag(tag) {
							return tagsToReplace[tag] || tag;
					}

					function safe_tags_replace(str) {
							return str.replace(/[&<>]/g, replaceTag);
					}
					function restoreURI(str) {
							return str.includes('<span style="color: cyan">majordomo</span>') ? decodeURI(str) : str;
					}
					// replace end

				function doConnect()
				{
					websocket = new WebSocket("ws://" + document.remote_log_form.terminal_ip.value + ":7999/");
					websocket.onopen = function(evt) { onOpen(evt) };
					websocket.onclose = function(evt) { onClose(evt) };
					websocket.onmessage = function(evt) { onMessage(evt) };
					websocket.onerror = function(evt) { onError(evt) };
				}

				function onOpen(evt)
				{
					writeToScreenMsg("connected");
					document.remote_log_form.connectButton.value = "Disconnect";
					websocket.send(document.remote_log_form.ws_token.value);
					websocket.send('remote_log');
				}

				function onClose(evt)
				{
					writeToScreenMsg("disconnected");
					document.remote_log_form.connectButton.value = "Connect";
				}

				function onMessage(evt)
				{
					writeToScreenLog(evt.data);
				}

				function onError(evt)
				{
					writeToScreenMsg('error: ' + evt.data);
					websocket.close();
				}

				function writeToScreenMsg(message)
				{
					writeToScreen('<span style="color: darkorange">' + message + '</span>');
				}

				function writeToScreenLog(message)
				{
					writeToScreen(ansispan(safe_tags_replace(message)));
				}

				function writeToScreen(message)
				{
					remote_log.innerHTML += message + "<br>";
					remote_log.scrollTop = remote_log.scrollHeight;
				}

				function clearText() {
							remote_log.innerHTML = "";
				 }

				 function doDisconnect() {
							websocket.close();
				 }

				 function doConnectDisconnect() {
							(document.remote_log_form.connectButton.value == "Connect") ? doConnect() : doDisconnect()
				 }
			</script>


		[#endif TITLE#]
    </div>
		[#end NAV-TABS#]

<script type="text/javascript">
$('#tab a:first').tab('show');
</script>
